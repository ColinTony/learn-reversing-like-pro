Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/xenial32"
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
  end

  # Map current directory to /vagrant to access WarGames files
  config.vm.synced_folder ".", "/vagrant"

  config.vm.provision "shell", inline: <<-SHELL
    export DEBIAN_FRONTEND=noninteractive
    
    # Enable 32-bit architecture (redundant on 32-bit box but harmless)
    # dpkg --add-architecture i386
    apt-get update
    
    # Install dependencies
    apt-get install -y \
      gcc gdb make binutils libc6-dev build-essential net-tools vim nano file strace sudo wget git curl python \
      libc6 libstdc++6 gdb \
      ca-certificates pkg-config python3 python3-pip libssl-dev libzip-dev zlib1g-dev liblz4-dev

    # Build Radare2 (Version from August 2025)
    if [ ! -d "/tmp/radare2" ]; then
      cd /tmp
      git clone https://github.com/radareorg/radare2
      cd radare2
      
      # Checkout version from approx August 2025
      # We use a date-based checkout to get a stable version from that time
      git checkout $(git rev-list -n 1 --before="2025-08-15" master)
      
      # Configure
      ./configure --prefix=/usr

      # Pre-clone QuickJS to patch it before compilation
      # This prevents the "label can only be part of a statement" error on older GCC
      # We clone the version that matches the submodule in the checked-out radare2
      git submodule update --init subprojects/qjs
      sed -i 's/unsigned short cw;/; unsigned short cw;/g' subprojects/qjs/cutils.h

      # Compile and Install
      make -j2
      make install
      ldconfig
      
      cd /root
      rm -rf /tmp/radare2
    fi

    # Install Pwndbg
    curl -qsL 'https://install.pwndbg.re' | sh -s -- -t pwndbg-gdb

    # Setup Exercises
    mkdir -p /opt/protostar/bin
    mkdir -p /opt/ejercicios/bin

    # Copy files from /vagrant (synced folder)
    if [ -d "/vagrant/WarGames/protostar_build/protostar/bin" ]; then
      cp /vagrant/WarGames/protostar_build/protostar/bin/stack* /opt/protostar/bin/
    fi
    if [ -d "/vagrant/WarGames/ejercicios" ]; then
      cp /vagrant/WarGames/ejercicios/*.c /opt/ejercicios/bin/
    fi

    # Compile p100
    cd /opt/ejercicios/bin/
    gcc -fno-stack-protector -z execstack ./p100.c -o ./p100

    # Set Permissions (SUID)
    chown -R root:root /opt/protostar/bin/
    chmod 4755 /opt/protostar/bin/stack*
    chmod 4755 /opt/ejercicios/bin/*
    chmod 600 /opt/ejercicios/bin/*.c

    # Install Python 2 pip
    wget https://bootstrap.pypa.io/pip/2.7/get-pip.py -O /tmp/get-pip.py
    python /tmp/get-pip.py

    echo "Vagrant provisioning complete!"
  SHELL
end
