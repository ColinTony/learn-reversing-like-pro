Vagrant.configure("2") do |config|
  config.vm.box = "debian/bullseye64"
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
  end

  # Map current directory to /vagrant to access WarGames files
  config.vm.synced_folder ".", "/vagrant"

  config.vm.provision "shell", inline: <<-SHELL
    export DEBIAN_FRONTEND=noninteractive
    
    # Enable 32-bit architecture
    dpkg --add-architecture i386
    apt-get update
    
    # Install dependencies
    apt-get install -y \
      gcc gdb make binutils libc6-dev build-essential net-tools vim nano file strace sudo wget git curl python2 \
      libc6:i386 libstdc++6:i386 gdb \
      ca-certificates pkg-config python3 python3-pip libssl-dev libzip-dev zlib1g-dev liblz4-dev

    # Install Meson and Ninja
    pip3 install meson ninja

    # Build Radare2
    if [ ! -d "/tmp/radare2" ]; then
      git clone https://github.com/radareorg/radare2 /tmp/radare2
      cd /tmp/radare2
      meson setup build
      # Apply QuickJS patch
      sed -i 's/unsigned short cw;/; unsigned short cw;/g' subprojects/qjs/cutils.h
      ninja -C build
      ninja -C build install
      ldconfig
      cd /root
      rm -rf /tmp/radare2
    fi

    # Install Pwndbg
    curl -qsL 'https://install.pwndbg.re' | sh -s -- -t pwndbg-gdb

    # Setup Exercises
    mkdir -p /opt/protostar/bin
    mkdir -p /opt/ejercicios/bin

    # Copy files from /vagrant (synced folder)
    if [ -d "/vagrant/WarGames/protostar_build/protostar/bin" ]; then
      cp /vagrant/WarGames/protostar_build/protostar/bin/stack* /opt/protostar/bin/
    fi
    if [ -d "/vagrant/WarGames/ejercicios" ]; then
      cp /vagrant/WarGames/ejercicios/*.c /opt/ejercicios/bin/
    fi

    # Compile p100
    cd /opt/ejercicios/bin/
    gcc -fno-stack-protector -z execstack ./p100.c -o ./p100

    # Set Permissions (SUID)
    chown -R root:root /opt/protostar/bin/
    chmod 4755 /opt/protostar/bin/stack*
    chmod 4755 /opt/ejercicios/bin/*
    chmod 600 /opt/ejercicios/bin/*.c

    # Create testing user
    if ! id "testing" &>/dev/null; then
      useradd -m -s /bin/bash testing
      echo "testing:testing" | chpasswd
      echo "testing ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
    fi

    # Install Python 2 pip
    wget https://bootstrap.pypa.io/pip/2.7/get-pip.py -O /tmp/get-pip.py
    python2 /tmp/get-pip.py

    echo "Vagrant provisioning complete!"
  SHELL
end
