FROM i386/debian:bullseye

# Actualiza e instala solo lo necesario
RUN dpkg --add-architecture i386 && \
    apt-get update && \
    apt-get install -y \
    gcc \
    gdb \
    make \
    binutils \
    libc6-dev \
    build-essential \
    net-tools \
    vim \
    nano \
    file \
    strace \
    sudo \
    wget \
    git \
    curl \
    python \
    libc6:i386 libstdc++6:i386 gdb

# ==========================================
# RADARE
# ===== RADARE2 (build from source, bullseye i386) =====
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    ca-certificates \
    curl \
    build-essential \
    pkg-config \
    meson \
    ninja-build \
    python3 \
    python3-pip \
    libssl-dev \
    libzip-dev \
    zlib1g-dev \
    liblz4-dev \
    && rm -rf /var/lib/apt/lists/*

RUN wget https://github.com/radareorg/radare2/archive/refs/tags/5.9.0.tar.gz -O /tmp/radare2.tar.gz && \
    tar -xzf /tmp/radare2.tar.gz -C /tmp && \
    cd /tmp/radare2-5.9.0 && \
    meson setup build && \
    ninja -C build && \
    ninja -C build install && \
    ldconfig && \
    rm -rf /tmp/radare2*

#pwndbg
RUN curl -qsL 'https://install.pwndbg.re' | sh -s -- -t pwndbg-gdb

# === Protostar stack binaries with SUID ===
RUN mkdir -p /opt/protostar/bin
RUN mkdir -p /opt/ejercicios/bin

COPY ./WarGames/protostar_build/protostar/bin/stack* /opt/protostar/bin/
COPY ./WarGames/ejercicios/*.c /opt/ejercicios/bin/

# Compilacion de ejericcios
RUN cd /opt/ejercicios/bin/ && gcc -fno-stack-protector -z execstack ./p100.c -o ./p100

# Propietario root y SUID (rws para root)
RUN chown root:root /opt/protostar/bin/
RUN chmod 4755 /opt/protostar/bin/stack*
RUN chmod 4755 /opt/ejercicios/bin/*
RUN chmod 600 /opt/ejercicios/bin/*.c 

# ==========================================

RUN useradd -m -s /bin/bash testing
WORKDIR /share

#Pythoin
RUN wget https://bootstrap.pypa.io/pip/2.7/get-pip.py
RUN python ./get-pip.py

USER testing
# Deja listo el contenedor para compilar binarios vulnerables
CMD ["/bin/bash"]
